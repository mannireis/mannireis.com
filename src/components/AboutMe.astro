---
const { env } = Astro.locals.runtime;
const lastfmKey = env.LASTFM_KEY;
---

<!-- About me component -->
<div class="grid">
    <div class="content-1">
        <h2>Haiii, Iâ€™m manni,</h2>
        <h3>a 14yo that loves being silly.</h3>
        <p>
            im interested in: hardware, gamedev, gaming, programming, reading
            and being outside. Im also a proud member of Hack Club.
        </p>
    </div>
    <div class="content-2">
        <div class="current-song" data-lastfm-key={lastfmKey}>
            <img src="" alt="cover-art" class="cover-art" />
            <div class="song-name-wrapper">
                <h2 class="current-song-name"></h2>
            </div>
        </div>

        <div class="hackatime-stats">
            <h2 class="time"></h2>
        </div>
    </div>
</div>

<style>
    .song-name-wrapper {
        overflow: hidden;
        white-space: nowrap;
        flex: 1;
        min-width: 0;
    }

    .current-song-name {
        display: inline-block;
    }

    .current-song-name.overflow {
        animation: marquee 4s ease-in-out infinite alternate;
    }

    @keyframes marquee {
        0% {
            transform: translateX(0);
        }
        100% {
            transform: translateX(calc(-100% + 100cqw));
        }
    }

    .song-name-wrapper {
        container-type: inline-size;
    }

    .cover-art {
        margin-right: 10px;
        justify-self: start;
        border-radius: 8px;
        width: 80px;
        height: 80px;
    }

    .hackatime-stats {
        display: flex;
        height: 50px;
        width: 100%;
        background-color: #ec7357;
        padding: 10px;
        justify-content: center;
        align-items: center;
        border-radius: 8px;
    }

    .current-song {
        display: flex;
        height: 100px;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        background-color: #ec7357;
        padding: 10px;
        align-items: center;
        border-radius: 8px;
    }

    .time::selection {
        background-color: #138ca8;
    }

    h2,
    h3,
    p {
        margin-top: 3px;
    }

    .grid {
        display: grid;
        grid-template-rows: repeat(1, 1fr);
        grid-template-columns: repeat(2, 1fr);
        align-items: start;
        gap: 20px;
        margin: 40px 0px 40px;
        width: 100%;
        height: 600px;
        background-color: #ec735710;
        border: 4px solid #ec7357;
        border-radius: 8px;
    }

    .content-2 {
        border-left: 4px dashed #ec7357;
        padding: 20px;
        width: 100%;
        min-width: 0;
        overflow: hidden;
        height: 100%;
        grid-column: 2 / 2;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .content-1 {
        padding: 20px;
        grid-column: 1 / 2;
    }
</style>

<script>
    const container = document.querySelector(
        ".current-song[data-lastfm-key]",
    ) as HTMLElement;
    const lastfmKey = container?.dataset.lastfmKey;

    async function updateStats() {
        const today = new Date();

        const [lastfmData, data] = await Promise.all([
            fetch(
                "http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=mannireis&api_key=" +
                    lastfmKey +
                    "&format=json",
            ).then((res) => res.json()),
            fetch(
                "https://hackatime.hackclub.com/api/v1/users/maddy/stats?start_date=" +
                    today.toISOString().split("T")[0],
            ).then((res) => res.json()),
        ]);

        const currentSongTitle = lastfmData.recenttracks.track[0].name;
        const currentSongArtist =
            lastfmData.recenttracks.track[0].artist["#text"];
        const currentSongCover =
            lastfmData.recenttracks.track[0].image[2]["#text"];

        const time = data.data?.human_readable_total.slice(0, 6) ?? "unknown";
        document.querySelector(".time").textContent = time;

        const songNameEl = document.querySelector(
            ".current-song-name",
        ) as HTMLElement;
        const wrapperEl = document.querySelector(
            ".song-name-wrapper",
        ) as HTMLElement;
        songNameEl.textContent = currentSongTitle + " - " + currentSongArtist;

        if (songNameEl.scrollWidth > wrapperEl.clientWidth) {
            songNameEl.classList.add("overflow");
        } else {
            songNameEl.classList.remove("overflow");
        }

        (document.querySelector(".cover-art") as HTMLImageElement).src =
            currentSongCover;
    }

    updateStats();
    setInterval(updateStats, 4000);
</script>
